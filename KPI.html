<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Team Progress Tracker</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #f5f7fa;
    padding: 20px;
    color: #333;
  }
  h1 {
    text-align: center;
    color: #2c3e50;
  }
  .controls,
  .filters {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    justify-content: center;
    margin: 10px auto;
    max-width: 1100px;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin: 20px auto;
    background: #fff;
  }
  th,
  td {
    padding: 10px;
    border: 1px solid #ddd;
    text-align: center;
  }
  thead {
    background: #3498db;
    color: #fff;
  }
  .metric-header {
    position: relative;
  }
  .metric-header input {
    width: 100%;
    border: none;
    background: transparent;
    color: white;
    font-weight: bold;
    text-align: center;
  }
  .del-col {
    position: absolute;
    top: 2px;
    right: 2px;
    background: #e74c3c;
    border: none;
    color: #fff;
    border-radius: 50%;
    width: 18px;
    height: 18px;
    cursor: pointer;
    display: none;
  }
  .metric-header:hover .del-col {
    display: inline;
  }
  button {
    padding: 6px 10px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    background: #3498db;
    color: #fff;
  }
  button:disabled {
    background: #ccc;
    cursor: not-allowed;
  }
  .charts {
    display: flex;
    flex-direction: column; /* Yearly on top, Monthly below */
    gap: 20px;
    justify-content: center;
    max-width: 1100px;
    margin: auto;
  }
  canvas {
    background: #fff;
    border: 1px solid #ddd;
    padding: 10px;
    border-radius: 6px;
  }
  tr.locked {
    background: #eee !important;
  }

  /* Yearly Progress (avatars + scores) */
  .yearly-list {
    display: flex;
    gap: 10px;
  }
  .yearly-list.horizontal {
    flex-direction: row;
    flex-wrap: wrap;
    justify-content: flex-start;
  }
  .member-progress {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px;
    background: #fff;
    border: 1px solid #ddd;
    padding: 10px;
    border-radius: 8px;
    width: 130px;
  }
  .member-progress img {
    width: 58px;
    height: 58px;
    border-radius: 50%;
    object-fit: cover;
    border: 1px solid #bbb;
    cursor: pointer; /* disabled for non-admin in JS */
  }
  .member-progress .name {
    font-weight: 600;
    font-size: 14px;
    text-align: center;
  }
  .member-progress .score {
    font-size: 13px;
  }

  /* Highlight borders for Top 3 */
  .top1 img { border: 10px solid gold; }
  .top2 img { border: 10px solid silver; }
  .top3 img { border: 10px solid #cd7f32; } /* bronze */

  /* Rank badge appended to name */
  .rank {
    font-weight: bold;
    font-size: 12px;
    color: #333;
    margin-left: 4px;
  }

  @media (max-width: 900px) {
    .member-progress { width: 45%; }
  }
  @media (max-width: 600px) {
    .member-progress { width: 100%; }
  }
</style>
</head>
<body>
<h1>Team Progress Tracker</h1>

<div class="controls passcode">
  <label>Admin Passcode:
    <input type="password" id="pass" />
  </label>
  <button id="login">Login</button>
</div>

<div class="charts">
  <!-- YEARLY (on top) -->
  <div style="width: 100%;">
    <h3>Yearly Progress</h3>
    <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:8px;">
      <label>Filter Year:
        <select id="filterYear">
          <option value="all">All</option>
        </select>
      </label>
      <button id="btnTop3">Show Top 3</button>
    </div>
    <div id="yearlyProgress" class="yearly-list horizontal"></div>
  </div>

  <!-- MONTHLY (below) -->
  <div style="width: 100%;">
    <h3>Monthly Chart</h3>
    <div class="controls filters" style="justify-content:flex-start;padding-left:0;">
      <label>Filter Month:
        <select id="filterMonth">
          <option value="all">All</option>
        </select>
      </label>
      <label>Filter Member:
        <select id="filterMember">
          <option value="all">All</option>
        </select>
      </label>
      <button id="addMember" disabled>Add Member</button>
      <button id="addMetric" disabled>Add Metric</button>
      <button id="export" disabled>Export CSV</button>
    </div>
    <canvas id="monthlyChart" width="1000" height="320"></canvas>
  </div>
</div>

<table id="teamTable">
  <thead>
    <tr id="headerRow">
      <th>Name</th>
      <th>Month</th>
      <!-- metric headers will be injected here -->
      <th>Total</th>
      <th>Comment</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody id="teamBody"></tbody>
</table>

<!-- Hidden file input used for avatar uploads -->
<input type="file" id="avatarInput" accept="image/*" style="display:none" />

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
(() => {
  const PASS = "admin123";
  const LS_KEY = "tpt_state_v3";

  let metrics = [
    "Target Utilization",
    "Timesheet On Time",
    "WFH On Time",
    "Shift",
    "Attendance",
  ];
  let admin = false;

  // Avatar storage (persisted: member -> dataURL)
  let memberAvatars = {};
  let pendingAvatarFor = null; // which member's avatar are we uploading?

  // DOM references
  const passInput = document.getElementById("pass");
  const loginBtn = document.getElementById("login");
  const addMemberBtn = document.getElementById("addMember");
  const addMetricBtn = document.getElementById("addMetric");
  const exportBtn = document.getElementById("export");

  const filterMonth = document.getElementById("filterMonth");
  const filterMember = document.getElementById("filterMember");
  const filterYear = document.getElementById("filterYear");
  const btnTop3 = document.getElementById("btnTop3");

  const teamBody = document.getElementById("teamBody");
  const headerRow = document.getElementById("headerRow");
  const monthlyCtx = document.getElementById("monthlyChart").getContext("2d");
  let monthlyChart = null;

  const avatarInput = document.getElementById("avatarInput");

  /* =======================
     Persistence (localStorage)
     ======================= */
  function saveState() {
   const rows = [...teamBody.rows].map((r) => {
  const name = r.children[0].textContent;
  const month = r.children[1].textContent;
  const selects = [...r.querySelectorAll("select")].map((s) => s.value);
  const total = r.querySelector(".score").textContent;
  const comment = r.querySelector(".comment")?.value || "";
  const locked = r.classList.contains("locked");
  return { name, month, values: selects, total, comment, locked };
});
    const state = { metrics, rows, avatars: memberAvatars };
    localStorage.setItem(LS_KEY, JSON.stringify(state));
  }

  function loadState() {
    const raw = localStorage.getItem(LS_KEY);
    if (!raw) return null;
    try {
      return JSON.parse(raw);
    } catch {
      return null;
    }
  }

  /* =======================
     Headers / Table Building
     ======================= */
function renderHeaders() {
  // Keep: Name (0), Month (1), Total (after metrics), Comment, Actions
  // Remove only metrics (between Month and Total)
  while (headerRow.children.length > 5) {
    headerRow.removeChild(headerRow.children[2]); 
  }

  metrics.forEach((m, i) => {
    const th = document.createElement("th");
    th.className = "metric-header";

    if (admin) {
      const input = document.createElement("input");
      input.value = m;
      input.addEventListener("change", () => {
        const old = metrics[i];
        metrics[i] = input.value.trim() || old;
        renderHeaders();
        rebuildRowsForMetricsChange();
        updateAll();
      });
      th.appendChild(input);

      const delBtn = document.createElement("button");
      delBtn.className = "del-col";
      delBtn.textContent = "Ã—";
      delBtn.title = `Delete metric "${metrics[i]}"`;
      delBtn.addEventListener("click", () => {
        if (confirm(`Delete metric "${metrics[i]}" and remove from all data?`)) {
          [...teamBody.rows].forEach((r) => {
            r.children[2 + i].remove();
          });
          metrics.splice(i, 1);
          renderHeaders();
          updateAll();
        }
      });
      th.appendChild(delBtn);
    } else {
      th.textContent = m;
    }

    headerRow.insertBefore(th, headerRow.children[headerRow.children.length - 3]);
  });
}

  function createRowFromData({ name, month, values = [], locked = false }) {
    const tr = document.createElement("tr");
    if (locked) tr.classList.add("locked");

    tr.innerHTML = `<td>${name}</td><td>${month}</td>`;

    // Ensure values length matches metrics
    const vals = values.slice();
    while (vals.length < metrics.length) vals.push("No");
    if (vals.length > metrics.length) vals.length = metrics.length;

    vals.forEach((val) => {
      const td = document.createElement("td");
      const sel = document.createElement("select");
      sel.innerHTML = "<option>No</option><option>Yes</option>";
      sel.value = val === "Yes" ? "Yes" : "No";
      sel.disabled = !admin || locked;
      sel.addEventListener("change", () => {
        if (tr.classList.contains("locked") || !admin) return;
        updateScore(tr);
        saveState();
        updateAllVisualsOnly();
      });
      td.appendChild(sel);
      tr.appendChild(td);
    });

    const totalTd = document.createElement("td");
    totalTd.className = "score";
    tr.appendChild(totalTd);
    const commentTd = document.createElement("td");
    const commentInput = document.createElement("input");
    commentInput.type = "text";
    commentInput.className = "comment";
    commentInput.value = (arguments[0].comment || "");
    commentInput.disabled = !admin || locked;
    commentInput.addEventListener("change", () => saveState());
    commentTd.appendChild(commentInput);
    tr.appendChild(commentTd);

    const actionsTd = document.createElement("td");
    const editBtn = document.createElement("button");
    editBtn.textContent = "Edit";
    editBtn.disabled = !admin || locked;

    const delBtn = document.createElement("button");
    delBtn.textContent = "Delete";
    delBtn.disabled = !admin || locked;

    const lockBtn = document.createElement("button");
    lockBtn.textContent = locked ? "Unlock" : "Lock";
    lockBtn.disabled = !admin;

    actionsTd.appendChild(editBtn);
    actionsTd.appendChild(delBtn);
    actionsTd.appendChild(lockBtn);
    tr.appendChild(actionsTd);

    teamBody.appendChild(tr);

    // Edit name (admin only)
    editBtn.addEventListener("click", () => {
      if (!admin || tr.classList.contains("locked")) return;
      const tdName = tr.children[0];
      const oldName = tdName.textContent;
      const input = document.createElement("input");
      input.value = oldName;
      tdName.textContent = "";
      tdName.appendChild(input);
      input.focus();

      const commit = () => {
        const newName = input.value.trim() || oldName;
        // Move avatar mapping if exists
        if (memberAvatars[oldName] && !memberAvatars[newName]) {
          memberAvatars[newName] = memberAvatars[oldName];
          delete memberAvatars[oldName];
        }
        tdName.textContent = newName;
        updateMemberFilters();
        saveState();
        updateAll();
      };
      input.addEventListener("blur", commit);
      input.addEventListener("keydown", (e) => {
        if (e.key === "Enter") commit();
        if (e.key === "Escape") { tdName.textContent = oldName; }
      });
    });

    // Delete row (admin only)
    delBtn.addEventListener("click", () => {
      if (!admin || tr.classList.contains("locked")) return;
      if (confirm("Delete this row?")) {
        tr.remove();
        updateMemberFilters();
        updateMonthFilters();
        updateYearFilters();
        saveState();
        updateAll();
      }
    });

    // Lock / Unlock (admin only)
    lockBtn.addEventListener("click", () => {
      if (!admin) return;
      tr.classList.toggle("locked");
      lockBtn.textContent = tr.classList.contains("locked") ? "Unlock" : "Lock";
      // enable/disable selects based on lock state
      tr.querySelectorAll("select").forEach(sel => sel.disabled = !admin || tr.classList.contains("locked"));
      //disable comment input
      tr.querySelector(".comment").disabled = !admin || tr.classList.contains("locked");
      // enable/disable edit/delete
      editBtn.disabled = !admin || tr.classList.contains("locked");
      delBtn.disabled = !admin || tr.classList.contains("locked");
      saveState();
      updateAll();
    
    });

    updateScore(tr);
  }

  function updateScore(tr) {
    let total = 0;
    tr.querySelectorAll("select").forEach((sel) => {
      if (sel.value === "Yes") total++;
    });
    tr.querySelector(".score").textContent = total;
  }

  function rebuildRowsForMetricsChange() {
    const stateRows = [...teamBody.rows].map((r) => {
      return {
        name: r.children[0].textContent,
        month: r.children[1].textContent,
        values: [...r.querySelectorAll("select")].map(s => s.value),
        locked: r.classList.contains("locked")
      };
    });
    teamBody.innerHTML = "";
    stateRows.forEach((row) => createRowFromData(row));
    saveState();
  }

  /* =======================
     Filters
     ======================= */
  function updateMemberFilters() {
    const members = new Set();
    [...teamBody.rows].forEach((r) => members.add(r.children[0].textContent));
    const current = filterMember.value;
    filterMember.innerHTML = '<option value="all">All</option>';
    Array.from(members).sort().forEach((m) => {
      const opt = document.createElement("option");
      opt.value = m;
      opt.textContent = m;
      filterMember.appendChild(opt);
    });
    filterMember.value = [...members].includes(current) ? current : "all";
  }

  function updateMonthFilters() {
    const months = new Set();
    [...teamBody.rows].forEach((r) => months.add(r.children[1].textContent));
    const current = filterMonth.value;
    filterMonth.innerHTML = '<option value="all">All</option>';
    Array.from(months)
      .sort((a, b) => new Date(a) - new Date(b))
      .forEach((m) => {
        const opt = document.createElement("option");
        opt.value = m;
        opt.textContent = m;
        filterMonth.appendChild(opt);
      });
    filterMonth.value = [...months].includes(current) ? current : "all";
  }

  function updateYearFilters() {
    const years = new Set();
    [...teamBody.rows].forEach((r) => {
      const year = r.children[1].textContent.split(" ").pop();
      if (year) years.add(year);
    });
    const current = filterYear.value;
    filterYear.innerHTML = '<option value="all">All</option>';
    Array.from(years).sort().forEach((y) => {
      const opt = document.createElement("option");
      opt.value = y;
      opt.textContent = y;
      filterYear.appendChild(opt);
    });
    filterYear.value = [...years].includes(current) ? current : "all";
  }

  function getFilteredMonthlyRows() {
    const monthF = filterMonth.value;
    const memberF = filterMember.value.toLowerCase();
    return [...teamBody.rows].filter((r) => {
      const rowMonth = r.children[1].textContent;
      const rowMember = r.children[0].textContent.toLowerCase();
      if (monthF !== "all" && rowMonth !== monthF) return false;
      if (memberF !== "all" && rowMember !== memberF) return false;
      return true;
    });
  }

  function getFilteredYearlyRows() {
    const yearF = filterYear.value;
    return [...teamBody.rows].filter((r) => {
      const parts = r.children[1].textContent.trim().split(" ");
      const rowYear = parts[parts.length - 1];
      if (yearF !== "all" && rowYear !== yearF) return false;
      return true;
    });
  }

  /* =======================
     Charts & Yearly List
     ======================= */
  function updateMonthlyChart() {
    const filteredRows = getFilteredMonthlyRows();

    if (filterMember.value !== "all") {
      const monthScores = {};
      filteredRows.forEach((r) => {
        const month = r.children[1].textContent;
        const score = Number(r.querySelector(".score").textContent) || 0;
        monthScores[month] = (monthScores[month] || 0) + score;
      });

      const labels = Object.keys(monthScores).sort((a, b) => new Date(a) - new Date(b));
      const data = labels.map((m) => monthScores[m]);

      if (monthlyChart) monthlyChart.destroy();
      monthlyChart = new Chart(monthlyCtx, {
        type: "bar",
        data: { labels, datasets: [{ label: "Monthly Progress for " + filterMember.value, data }] },
        options: { responsive: false, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
      });
    } else {
      const scores = {};
      filteredRows.forEach((r) => {
        const member = r.children[0].textContent;
        const score = Number(r.querySelector(".score").textContent) || 0;
        scores[member] = (scores[member] || 0) + score;
      });

      const labels = Object.keys(scores).sort();
      const data = labels.map((m) => scores[m]);

      if (monthlyChart) monthlyChart.destroy();
      monthlyChart = new Chart(monthlyCtx, {
        type: "bar",
        data: { labels, datasets: [{ label: filterMonth.value === "all" ? "Score (All Months)" : "Score (" + filterMonth.value + ")", data }] },
        options: { responsive: false, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
      });
    }
  }

  function updateYearlyList() {
    const container = document.getElementById("yearlyProgress");
    container.innerHTML = "";

    const filteredRows = getFilteredYearlyRows();
    const scores = {};

    filteredRows.forEach((r) => {
      const member = r.children[0].textContent;
      const score = Number(r.querySelector(".score").textContent) || 0;
      scores[member] = (scores[member] || 0) + score;
    });

    const members = Object.keys(scores).sort();
    if (members.length === 0) {
      container.innerHTML = '<div style="padding:10px;background:#fff;border:1px solid #ddd;border-radius:6px;text-align:center;">No data for selected year.</div>';
      return;
    }

    members.forEach((member) => {
      const card = document.createElement("div");
      card.className = "member-progress";

      const img = document.createElement("img");
      img.src = memberAvatars[member] || "https://via.placeholder.com/58";
      img.alt = member;

      if (admin) {
        img.title = "Click to change avatar";
        img.addEventListener("click", () => {
          pendingAvatarFor = member;
          avatarInput.value = ""; // reset so selecting same file works
          avatarInput.click();
        });
      } else {
        img.style.cursor = "default";
        img.title = "";
      }

      const nameDiv = document.createElement("div");
      nameDiv.className = "name";
      nameDiv.textContent = member;

      const scoreDiv = document.createElement("div");
      scoreDiv.className = "score";
      scoreDiv.textContent = "Score: " + (scores[member] || 0);

      card.appendChild(img);
      card.appendChild(nameDiv);
      card.appendChild(scoreDiv);
      container.appendChild(card);
    });
  }

  // Handle hidden file input for avatar uploads (admin only)
  avatarInput.addEventListener("change", (e) => {
    if (!admin) return;
    const file = e.target.files?.[0];
    if (!file || !pendingAvatarFor) return;
    const reader = new FileReader();
    reader.onload = (ev) => {
      memberAvatars[pendingAvatarFor] = ev.target.result; // base64 data URL
      saveState();
      updateYearlyList(); // refresh images
      pendingAvatarFor = null;
    };
    reader.readAsDataURL(file);
  });

  function highlightTop3() {
    // Remove old highlights & rank badges
    document.querySelectorAll(".member-progress").forEach((el) => {
      el.classList.remove("top1", "top2", "top3");
      const nameEl = el.querySelector(".name");
      if (!nameEl) return;
      const oldRank = nameEl.querySelector(".rank");
      if (oldRank) oldRank.remove();
    });

    const filteredRows = getFilteredYearlyRows();
    const scores = {};
    filteredRows.forEach((r) => {
      const member = r.children[0].textContent;
      const score = Number(r.querySelector(".score").textContent) || 0;
      scores[member] = (scores[member] || 0) + score;
    });

    const top3 = Object.entries(scores)
      .sort((a, b) => b[1] - a[1])
      .slice(0, 3);

    top3.forEach(([member], index) => {
      const rank = index + 1;
      // After removing rank spans above, .name textContent equals the member name
      const card = [...document.querySelectorAll(".member-progress")]
        .find(c => (c.querySelector(".name")?.textContent || "") === member);
      if (card) {
        card.classList.add("top" + rank);
        const rankSpan = document.createElement("span");
        rankSpan.className = "rank";
        rankSpan.textContent = ` (#${rank})`;
        card.querySelector(".name").appendChild(rankSpan);
      }
    });
  }

  /* =======================
     Helpers to update UI
     ======================= */
  function updateAllVisualsOnly() {
    updateMonthlyChart();
    updateYearlyList();
  }

  function updateAll() {
    updateMemberFilters();
    updateMonthFilters();
    updateYearFilters();
    updateAllVisualsOnly();
    saveState();
  }

  function applyAdminStateToExistingRows() {
    [...teamBody.rows].forEach((tr) => {
      const locked = tr.classList.contains("locked");
      tr.querySelectorAll("select").forEach(sel => sel.disabled = !admin || locked);

      const [editBtn, delBtn, lockBtn] = tr.querySelectorAll("button");
      if (editBtn) editBtn.disabled = !admin || locked;
      if (delBtn) delBtn.disabled = !admin || locked;
      if (lockBtn) lockBtn.disabled = !admin;
    });

    addMemberBtn.disabled = !admin;
    addMetricBtn.disabled = !admin;
    exportBtn.disabled = !admin ? true : false;

    // Re-render headers so inputs/delete icons appear only for admin
    renderHeaders();
  }

  /* =======================
     CSV Export (monthly view)
     ======================= */
  function exportCSV() {
    const rows = getFilteredMonthlyRows();
    if (rows.length === 0) {
      alert("No data to export for the selected filters.");
      return;
    }

    const headerCells = ["Name", "Month", ...metrics, "Total"];
    const csvRows = [];
    csvRows.push(headerCells.join(","));

    rows.forEach((r) => {
      const rowData = [];
      rowData.push('"' + r.children[0].textContent + '"'); // name
      rowData.push('"' + r.children[1].textContent + '"'); // month
      r.querySelectorAll("select").forEach((sel) => {
        rowData.push('"' + sel.value + '"');
      });
      rowData.push(r.querySelector(".score").textContent);
      csvRows.push(rowData.join(","));
    });

    const csvString = csvRows.join("\n");
    const blob = new Blob([csvString], { type: "text/csv" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "team_progress.csv";
    a.click();
    URL.revokeObjectURL(url);
  }

  /* =======================
     Demo / Initialization
     ======================= */
  function addInitialData() {
    const seedRows = [
      { name: "KRCR", month: "August 2025", values: [] },
      { name: "APRJ", month: "August 2025", values: [] },
      { name: "JRAN", month: "August 2025", values: [] },
      { name: "APOM", month: "August 2025", values: [] },
      { name: "KICA", month: "August 2025", values: [] },
      { name: "JCAP", month: "August 2025", values: [] },
      { name: "JOMM", month: "August 2025", values: [] },
      { name: "MEDO", month: "August 2025", values: [] },
      { name: "RAOC", month: "August 2025", values: [] },
      { name: "JABM", month: "August 2025", values: [] },
      { name: "DRPE", month: "August 2025", values: [] },
      { name: "DBES", month: "August 2025", values: [] },

      { name: "KICA", month: "September 2025", values: [] },
      { name: "JCAP", month: "September 2025", values: [] },
      { name: "JOMM", month: "September 2025", values: [] },
      { name: "MEDO", month: "September 2025", values: [] },
      { name: "RAOC", month: "September 2025", values: [] },
      { name: "JABM", month: "September 2025", values: [] },
      { name: "DRPE", month: "September 2025", values: [] },
      { name: "DBES", month: "September 2025", values: [] },

      { name: "MBAR", month: "October 2025", values: [] },
      { name: "MBAR", month: "November 2025", values: [] },
      { name: "MBAR", month: "December 2025", values: [] },
    ];

    seedRows.forEach((r) => createRowFromData(r));
  }

  /* =======================
     Events
     ======================= */
  loginBtn.addEventListener("click", () => {
    if (passInput.value === PASS) {
      admin = true;
      alert("Admin mode enabled");
      passInput.disabled = true;
      loginBtn.disabled = true;
      applyAdminStateToExistingRows();
      updateAll();
    } else {
      alert("Wrong passcode");
    }
  });

  addMemberBtn.addEventListener("click", () => {
    if (!admin) return;
    const month = filterMonth.value;
    if (month === "all") {
      alert("Please select a specific month to add a member row (use Filter Month).");
      return;
    }
    const name = prompt("Enter member name:");
    if (name && name.trim()) {
      createRowFromData({ name: name.trim(), month, values: [] });
      updateAll();
    }
  });

  addMetricBtn.addEventListener("click", () => {
    if (!admin) return;
    const newMetric = prompt("Enter new metric name:");
    if (newMetric && newMetric.trim()) {
      metrics.push(newMetric.trim());
      renderHeaders();
      // Add a new metric select to each row (before Total)
      [...teamBody.rows].forEach((r) => {
        const selectTd = document.createElement("td");
        const select = document.createElement("select");
        select.innerHTML = "<option>No</option><option>Yes</option>";
        select.value = "No";
        select.disabled = !admin || r.classList.contains("locked");
        select.addEventListener("change", () => {
          if (!admin || r.classList.contains("locked")) return;
          updateScore(r);
          saveState();
          updateAllVisualsOnly();
        });
        selectTd.appendChild(select);
        r.insertBefore(selectTd, r.children[r.children.length - 2]); // before Total cell
      });
      saveState();
      updateAll();
    }
  });

  exportBtn.addEventListener("click", exportCSV);

  // Filters
  filterMonth.addEventListener("change", () => updateAllVisualsOnly());
  filterMember.addEventListener("change", () => updateAllVisualsOnly());
  filterYear.addEventListener("change", () => updateAllVisualsOnly());

  // Top 3 button
  btnTop3.addEventListener("click", highlightTop3);

  /* =======================
     Boot
     ======================= */
  function boot() {
    const state = loadState();
    if (state && Array.isArray(state.metrics) && Array.isArray(state.rows)) {
      metrics = state.metrics;
      memberAvatars = state.avatars || {};
      renderHeaders();
      teamBody.innerHTML = "";
      state.rows.forEach((row) => createRowFromData(row));
    } else {
      // First time load -> seed demo data
      renderHeaders();
      addInitialData();
      saveState();
    }

    // Non-admin default state (lock editing)
    applyAdminStateToExistingRows();

    // Build filters and visuals
    updateAll();
  }

  boot();
})();
</script>
</body>
</html>
